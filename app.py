import streamlit as st
import pandas as pd
import numpy as np
import io, os
import plotly.express as px
from datetime import datetime
from fpdf import FPDF

# ============ é¡µé¢é…ç½® ============
st.set_page_config(
    page_title="ğŸ“ˆ è‡ªåŠ¨åŒ–äº¤æ˜“åˆ†ææŠ¥å‘Šç”Ÿæˆå™¨",
    layout="wide",
    initial_sidebar_state="expanded",
    page_icon="ğŸ“Š"
)

# ============ å¤šè¯­è¨€æ”¯æŒ ============
LANG = {'ä¸­æ–‡': 'ğŸ“ˆ è‡ªåŠ¨åŒ–äº¤æ˜“åˆ†ææŠ¥å‘Šç”Ÿæˆå™¨', 'English': 'ğŸ“ˆ Automated Trading Report Generator'}
lang = st.sidebar.selectbox('è¯­è¨€ / Language', list(LANG.keys()))
st.title(LANG[lang])

# ============ ä¾§è¾¹æ ä¸Šä¼ ä¸è®¾ç½® ============
st.sidebar.header('ğŸ“ ä¸Šä¼ ä¸è®¾ç½®')
uploaded = st.sidebar.file_uploader('ä¸Šä¼ äº¤æ˜“ CSV', type='csv', accept_multiple_files=True)
market_file = st.sidebar.file_uploader('å¸‚åœºå¿«ç…§ CSV', type='csv')
sent_file = st.sidebar.file_uploader('èˆ†æƒ…æ•°æ® CSV', type='csv')
max_snapshots = st.sidebar.number_input('ä¿ç•™å¿«ç…§ä»½æ•°', min_value=1, value=10)
cache_days = st.sidebar.number_input('ç¼“å­˜å¤©æ•°ï¼ˆå¤©ï¼‰', min_value=1, value=1)
lookback_days = st.sidebar.slider('å›æ’¤å›æº¯æœŸ (å¤©)', 1, 60, 30)

SNAP_DIR = 'snapshots'
os.makedirs(SNAP_DIR, exist_ok=True)

# ============ æ•°æ®åŠ è½½ ============
@st.cache_data(show_spinner=False, max_entries=10, ttl=3600*24*cache_days)
def load_and_clean(files):
    def extract_orders(f):
        content = f.getvalue().decode('utf-8', errors='ignore').splitlines()
        idx = next((i for i,l in enumerate(content) if 'Completed Orders' in l), None)
        if idx is None: return pd.DataFrame()
        header = content[idx+1].replace('\"','').split(',')
        body   = '\n'.join(content[idx+2:])
        df = pd.read_csv(io.StringIO(body), names=header)
        df['ä¸Šä¼ æ–‡ä»¶'] = f.name
        return df
    dfs = [extract_orders(f) for f in files]
    df = pd.concat(dfs, ignore_index=True)
    df = df[df['Status']=='Filled']
    df = df[['Account','Buy/Sell','Symbol','Avg Fill Price','Qty To Fill',
             'Update Time (CST)','Commission Fill Rate','Closed Profit/Loss','ä¸Šä¼ æ–‡ä»¶']]
    df.columns = ['è´¦æˆ·','æ–¹å‘','å“ç§','ä»·æ ¼','æ•°é‡','æ—¶é—´','æ‰‹ç»­è´¹','ç›ˆäº','ä¸Šä¼ æ–‡ä»¶']
    df['æ—¶é—´'] = pd.to_datetime(df['æ—¶é—´'], errors='coerce_
